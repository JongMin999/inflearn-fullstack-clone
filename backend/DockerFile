FROM node:20-alpine

RUN npm install -g pnpm

WORKDIR /app

# Build arguments
ARG NODE_ENV=production
ARG DATABASE_URL
ARG AUTH_SECRET
ARG AWS_REGION
ARG AWS_ACCESS_KEY_ID
ARG AWS_SECRET_ACCESS_KEY
ARG AWS_MEDIA_S3_BUCKET_NAME
ARG CLOUDFRONT_DOMAIN
ARG PORTONE_API_SECRET
ARG PORTONE_WEBHOOK_SECRET

# Convert ARG to ENV for runtime
ENV NODE_ENV=${NODE_ENV}
ENV DATABASE_URL=${DATABASE_URL}
ENV AUTH_SECRET=${AUTH_SECRET}
ENV AWS_REGION=${AWS_REGION}
ENV AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
ENV AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
ENV AWS_MEDIA_S3_BUCKET_NAME=${AWS_MEDIA_S3_BUCKET_NAME}
ENV CLOUD_FRONT_DOMAIN=${CLOUDFRONT_DOMAIN}
ENV PORTONE_API_SECRET=${PORTONE_API_SECRET}
ENV PORTONE_WEBHOOK_SECRET=${PORTONE_WEBHOOK_SECRET}

COPY package.json pnpm-lock.yaml ./

COPY prisma/schema.prisma ./prisma/

RUN pnpm install

COPY . .

RUN pnpm prisma generate

RUN pnpm run build

EXPOSE 8000

CMD ["node", "dist/src/main.js"]