FROM node:20-alpine

RUN npm install -g pnpm

WORKDIR /app

# Build arguments
ARG NODE_ENV=production
ARG API_URL
ARG AUTH_SECRET
ARG DATABASE_URL
ARG CLOUDFRONT_DOMAIN
ARG NEXT_PUBLIC_PORTONE_STORE_ID
ARG NEXT_PUBLIC_PORTONE_CHANNEL_KEY
ARG NEXTAUTH_URL

# Convert ARG to ENV for runtime
ENV NODE_ENV=${NODE_ENV}
ENV API_URL=${API_URL}
ENV AUTH_SECRET=${AUTH_SECRET}
ENV DATABASE_URL=${DATABASE_URL}
ENV CLOUD_FRONT_DOMAIN=${CLOUDFRONT_DOMAIN}
ENV NEXT_PUBLIC_PORTONE_STORE_ID=${NEXT_PUBLIC_PORTONE_STORE_ID}
ENV NEXT_PUBLIC_PORTONE_CHANNEL_KEY=${NEXT_PUBLIC_PORTONE_CHANNEL_KEY}
ENV NEXTAUTH_URL=${NEXTAUTH_URL}

COPY package.json pnpm-lock.yaml ./

RUN pnpm install

COPY . .

RUN pnpm prisma generate

RUN pnpm run build

EXPOSE 3000

CMD ["pnpm", "run", "start"]